<!DOCTYPE html>
<html lang="ar" dir="rtl" translate="no">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="google" content="notranslate" />
    <title>Boyoticom Portal</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              brand: { 900: '#2C3340', 800: '#1e232e', 50: '#f0f9ff' },
              accent: { 400: '#E6BC76', 500: '#CE9B52', 600: '#b0823e' },
              crm: { 500: '#6366f1', 600: '#4f46e5' }
            },
            fontFamily: { sans: ['Cairo', 'sans-serif'] }
          }
        }
      }
    </script>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@200;300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Libraries -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/recharts@2.12.0/umd/Recharts.min.js"></script>
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
      body { font-family: 'Cairo', sans-serif; background-color: #f8fafc; color: #2C3340; }
      .date-en { font-family: sans-serif; direction: ltr; display: inline-block; }
      .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #2C3340; width: 24px; height: 24px; animation: spin 1s linear infinite; }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      .leaflet-container { width: 100%; height: 100%; z-index: 1; border-radius: 0.75rem; }
      .portal-card { transition: all 0.3s ease; }
      .portal-card:hover { transform: translateY(-5px); box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1); }
    </style>
</head>
<body class="notranslate">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
          apiKey: "AIzaSyAOMnl9ikDMngZZH-eSa3ldqtDCh6qsy_U",
          authDomain: "boyoticom-15c4b.firebaseapp.com",
          databaseURL: "https://boyoticom-15c4b-default-rtdb.firebaseio.com",
          projectId: "boyoticom-15c4b",
          storageBucket: "boyoticom-15c4b.firebasestorage.app",
          messagingSenderId: "433583401372",
          appId: "1:433583401372:web:2d483367ad0e0184a10059"
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, push, onValue, update, remove, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        const { useState, useEffect, useMemo, useRef, Component } = window.React;
        const Recharts = window.Recharts || {};
        const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip: RechartsTooltip, ResponsiveContainer, PieChart, Pie, Cell, Legend } = Recharts;

        // --- ERROR BOUNDARY ---
        class ErrorBoundary extends Component {
            constructor(props) { super(props); this.state = { hasError: false }; }
            static getDerivedStateFromError(error) { return { hasError: true }; }
            componentDidCatch(error, errorInfo) { console.error("Error:", error, errorInfo); }
            render() {
                if (this.state.hasError) return <div className="p-4 text-red-600 bg-red-50 rounded text-center">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¹Ø±Ø¶. <button onClick={()=>window.location.reload()} className="underline">ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©</button></div>;
                return this.props.children;
            }
        }

        // --- UTILS ---
        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };
        const safeStr = (val) => (val === null || val === undefined) ? '' : String(val);
        const safeArr = (val) => Array.isArray(val) ? val : [];
        const formatTime = (isoString) => new Date(isoString).toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' });
        const formatDate = (isoString) => new Date(isoString).toLocaleDateString('en-GB');
        
        const Logo = ({ size = 40 }) => {
            const [imgError, setImgError] = useState(false);
            if (imgError) { return (<div className="bg-brand-900 rounded-xl flex items-center justify-center text-accent-500" style={{ width: size, height: size }}><Icon name="box" size={size * 0.6} /></div>); }
            return (<img src="/logo.png" alt="Ø´Ø¹Ø§Ø±" className="object-contain" style={{ width: size, height: size }} onError={() => setImgError(true)} />);
        };

        const exportToExcel = (data, fileName) => { const worksheet = XLSX.utils.json_to_sheet(data); const workbook = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(workbook, worksheet, "Sheet1"); XLSX.writeFile(workbook, `${fileName}.xlsx`); };
        const calculateDuration = (start, end) => { if (!start || !end) return '-'; const diffMs = new Date(end) - new Date(start); const diffHrs = Math.floor((diffMs % 86400000) / 3600000); const diffMins = Math.round(((diffMs % 86400000) % 3600000) / 60000); return `${diffHrs}Ø³ ${diffMins}Ø¯`; };

        // --- CONSTANTS ---
        const STATUS_LIST = [ { key: 'New', label: 'Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯', color: 'bg-blue-50 text-blue-700 border-blue-200' }, { key: 'Contacted1', label: 'ØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ 1', color: 'bg-indigo-50 text-indigo-700 border-indigo-200' }, { key: 'Contacted2', label: 'ØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ 2', color: 'bg-purple-50 text-purple-700 border-purple-200' }, { key: 'Contacted3', label: 'ØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ 3', color: 'bg-fuchsia-50 text-fuchsia-700 border-fuchsia-200' }, { key: 'Deposit', label: 'Ø¯ÙØ¹ Ø¹Ø±Ø¨ÙˆÙ†', color: 'bg-amber-50 text-amber-700 border-amber-200' }, { key: 'Sold', label: 'ØªÙ… Ø§Ù„Ø¨ÙŠØ¹', color: 'bg-emerald-100 text-emerald-800 border-emerald-200' }, { key: 'Cancelled', label: 'Ù…Ù„ØºÙŠ', color: 'bg-red-50 text-red-700 border-red-200' }, ];
        const PROJECT_LIST = ["Ø¨ÙŠÙˆØªÙƒÙ… 10", "Ø¨ÙŠÙˆØªÙƒÙ… 11", "Ø¨ÙŠÙˆØªÙƒÙ… 12", "Ø¨ÙŠÙˆØªÙƒÙ… 13", "Ø¨ÙŠÙˆØªÙƒÙ… 14"];
        const CLIENT_SOURCES = ["Ù…Ø¨Ø§Ø´Ø±", "Ø¹Ù‚Ø§Ø±", "Ø§Ø¹Ù„Ø§Ù†Ø§Øª Ø±Ù‚Ù…ÙŠØ©", "ØªÙˆØµÙŠØ© ØµØ¯ÙŠÙ‚"];

        // --- 1. LOGIN COMPONENT ---
        const Login = () => {
            const [email, setEmail] = useState(''); const [password, setPassword] = useState(''); const [error, setError] = useState(''); const [loading, setLoading] = useState(false);
            const handleLogin = async (e) => { e.preventDefault(); setLoading(true); setError(''); try { await signInWithEmailAndPassword(auth, email, password); } catch (err) { setError('Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©'); setLoading(false); } };
            return (
                <div className="min-h-screen flex items-center justify-center bg-[#f8fafc] p-4">
                    <div className="bg-white p-10 rounded-3xl shadow-2xl w-full max-w-md text-center">
                        <div className="mx-auto flex items-center justify-center mb-6"><Logo size={80} /></div>
                        <h1 className="text-3xl font-black text-brand-900 mb-2">Ø¨ÙŠÙˆØªÙƒÙ… ERP</h1>
                        <p className="text-gray-500 mb-8">Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ù…ÙˆØ­Ø¯Ø©</p>
                        {error && <div className="bg-red-50 text-red-600 p-3 rounded-lg mb-4 text-sm font-bold">{error}</div>}
                        <form onSubmit={handleLogin} className="space-y-4">
                            <input className="w-full p-4 border rounded-xl bg-gray-50 text-right date-en outline-none focus:border-brand-900" type="email" required placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" value={email} onChange={e=>setEmail(e.target.value)} />
                            <input className="w-full p-4 border rounded-xl bg-gray-50 text-right date-en outline-none focus:border-brand-900" type="password" required placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" value={password} onChange={e=>setPassword(e.target.value)} />
                            <button disabled={loading} className="w-full bg-brand-900 text-white p-4 rounded-xl font-bold hover:bg-brand-800 transition shadow-lg disabled:opacity-70">{loading ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„...' : 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„'}</button>
                        </form>
                    </div>
                </div>
            );
        };

        // --- 2. USER MANAGEMENT (SEPARATED MODALS FOR STABILITY) ---
        
        // A. Add User Modal
        const AddUserModal = ({ isOpen, onClose, onSave }) => {
            const [newUser, setNewUser] = useState({ name: '', email: '', uid: '' });
            if(!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/50 z-[70] flex items-center justify-center p-4">
                    <div className="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl">
                        <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-lg">Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯</h3><button onClick={onClose}><Icon name="x"/></button></div>
                        <div className="space-y-3">
                            <div className="bg-yellow-50 p-3 rounded text-xs text-yellow-800"> Ø§Ù†Ø³Ø® Ø§Ù„Ù€ UID Ù…Ù† ØµÙØ­Ø© Authentication</div>
                            <input className="w-full border rounded p-3" value={newUser.name} onChange={e=>setNewUser({...newUser, name:e.target.value})} placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ" />
                            <input className="w-full border rounded p-3 text-right date-en" value={newUser.email} onChange={e=>setNewUser({...newUser, email:e.target.value})} placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" />
                            <input className="w-full border rounded p-3 text-right date-en font-mono" value={newUser.uid} onChange={e=>setNewUser({...newUser, uid:e.target.value})} placeholder="UID" />
                            <button onClick={() => onSave(newUser)} className="w-full bg-brand-900 text-white py-3 rounded-xl font-bold mt-2"><span>Ø­ÙØ¸ ÙˆÙ…ØªØ§Ø¨Ø¹Ø©</span></button>
                        </div>
                    </div>
                </div>
            );
        };

        // B. Role Editor Modal
        const RoleEditorModal = ({ user, isOpen, onClose, onSave }) => {
            const [crmRole, setCrmRole] = useState(user?.permissions?.crm_role || 'none');
            const [attRole, setAttRole] = useState(user?.permissions?.att_role || 'none');

            useEffect(() => {
                if(user) {
                    setCrmRole(user.permissions?.crm_role || 'none');
                    setAttRole(user.permissions?.att_role || 'none');
                }
            }, [user]);

            if (!isOpen || !user) return null;

            const handleSave = () => {
                const perms = { 
                    crm_access: crmRole !== 'none',
                    crm_role: crmRole,
                    crm_reports: crmRole === 'supervisor',
                    crm_delete: crmRole === 'supervisor',
                    crm_export: false, // Only admin
                    
                    att_access: attRole !== 'none',
                    att_role: attRole,
                    att_reports: attRole === 'supervisor',
                    att_zones: attRole === 'supervisor'
                };
                
                const apps = [];
                if (crmRole !== 'none') apps.push('crm');
                if (attRole !== 'none') apps.push('attendance');

                onSave(user.id, apps, perms);
            };

            return (
                <div className="fixed inset-0 bg-black/50 z-[70] flex items-center justify-center p-4">
                    <div className="bg-white w-full max-w-lg rounded-2xl p-6 shadow-2xl">
                        <div className="text-center mb-4 border-b pb-4">
                            <div className="font-bold text-xl text-brand-900">{user.name}</div>
                            <div className="text-xs text-gray-500">{user.email}</div>
                        </div>

                        <div className="space-y-4">
                            {/* CRM System */}
                            <div className="border rounded-xl p-4">
                                <div className="flex items-center gap-2 mb-3 text-crm-600 font-bold"><Icon name="layout-grid"/> Ù†Ø¸Ø§Ù… CRM</div>
                                <div className="grid grid-cols-3 gap-2">
                                    <button onClick={()=>setCrmRole('none')} className={`p-2 rounded border text-sm ${crmRole==='none'?'bg-gray-200':'bg-white'}`}>Ù„Ø§ ÙŠÙˆØ¬Ø¯</button>
                                    <button onClick={()=>setCrmRole('employee')} className={`p-2 rounded border text-sm ${crmRole==='employee'?'bg-crm-600 text-white':'bg-white'}`}>Ù…ÙˆØ¸Ù</button>
                                    <button onClick={()=>setCrmRole('supervisor')} className={`p-2 rounded border text-sm ${crmRole==='supervisor'?'bg-crm-600 text-white':'bg-white'}`}>Ù…Ø´Ø±Ù</button>
                                </div>
                            </div>

                            {/* Attendance System */}
                            <div className="border rounded-xl p-4">
                                <div className="flex items-center gap-2 mb-3 text-accent-600 font-bold"><Icon name="clock"/> Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ±</div>
                                <div className="grid grid-cols-3 gap-2">
                                    <button onClick={()=>setAttRole('none')} className={`p-2 rounded border text-sm ${attRole==='none'?'bg-gray-200':'bg-white'}`}>Ù„Ø§ ÙŠÙˆØ¬Ø¯</button>
                                    <button onClick={()=>setAttRole('employee')} className={`p-2 rounded border text-sm ${attRole==='employee'?'bg-accent-600 text-white':'bg-white'}`}>Ù…ÙˆØ¸Ù</button>
                                    <button onClick={()=>setAttRole('supervisor')} className={`p-2 rounded border text-sm ${attRole==='supervisor'?'bg-accent-600 text-white':'bg-white'}`}>Ù…Ø´Ø±Ù</button>
                                </div>
                            </div>
                        </div>

                        <div className="flex gap-2 mt-6 pt-4 border-t">
                            <button onClick={onClose} className="flex-1 bg-gray-100 py-3 rounded-xl font-bold">Ø¥Ù„ØºØ§Ø¡</button>
                            <button onClick={handleSave} className="flex-1 bg-brand-900 text-white py-3 rounded-xl font-bold">Ø­ÙØ¸ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN USER MANAGER (LIST) ---
        const UserManagerMain = ({ users, currentUser, onClose }) => {
            const [addModal, setAddModal] = useState(false);
            const [editUser, setEditUser] = useState(null);

            const displayUsers = users.filter(u => u.id !== currentUser.id);

            const handleSaveNew = (userData) => {
                if(!userData.uid) return alert('UID Ù…Ø·Ù„ÙˆØ¨');
                set(ref(db, `users/${userData.uid}`), { ...userData, role: 'user' }).then(() => {
                    setAddModal(false);
                    // Automatically open edit modal for permissions
                    setEditUser({ ...userData, id: userData.uid }); 
                });
            };

            const handleSaveRoles = (uid, apps, perms) => {
                update(ref(db, `users/${uid}`), { allowedApps: apps, permissions: perms });
                setEditUser(null);
            };

            return (
                <div className="fixed inset-0 bg-brand-900/70 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div className="bg-white w-full max-w-xl rounded-3xl p-6 shadow-2xl max-h-[90vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-6 border-b pb-4">
                            <h3 className="text-xl font-black text-brand-900 flex items-center gap-2"><Icon name="users"/> <span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</span></h3>
                            <button onClick={onClose} className="bg-gray-100 p-2 rounded-full hover:bg-gray-200"><Icon name="x"/></button>
                        </div>
                        
                        <div className="space-y-4">
                            <button onClick={() => setAddModal(true)} className="w-full bg-brand-900 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2 shadow"><Icon name="user-plus"/> <span>Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯</span></button>
                            <div className="space-y-2 mt-4">
                                {displayUsers.map(u => (
                                    <div key={u.id} className="flex justify-between items-center p-4 bg-white border rounded-xl hover:shadow-md transition cursor-pointer" onClick={()=>setEditUser(u)}>
                                        <div className="flex items-center gap-3">
                                            <div className="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center font-bold text-gray-600">{safeStr(u.name).charAt(0)}</div>
                                            <div><div className="font-bold text-brand-900">{u.name}</div><div className="text-xs text-gray-500">{u.email}</div></div>
                                        </div>
                                        <div className="flex items-center gap-2 text-xs text-gray-400">
                                            {u.permissions?.crm_role && u.permissions.crm_role !== 'none' && <span className="bg-blue-100 text-blue-700 px-2 py-1 rounded">CRM: {u.permissions.crm_role}</span>}
                                            {u.permissions?.att_role && u.permissions.att_role !== 'none' && <span className="bg-green-100 text-green-700 px-2 py-1 rounded">Att: {u.permissions.att_role}</span>}
                                            <Icon name="settings-2" size={16}/>
                                        </div>
                                    </div>
                                ))}
                                {displayUsers.length === 0 && <div className="text-center py-10 text-gray-400"><span>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙŠÙ† Ø¢Ø®Ø±ÙŠÙ†.</span></div>}
                            </div>
                        </div>
                    </div>

                    <AddUserModal isOpen={addModal} onClose={()=>setAddModal(false)} onSave={handleSaveNew} />
                    <RoleEditorModal user={editUser} isOpen={!!editUser} onClose={()=>setEditUser(null)} onSave={handleSaveRoles} />
                </div>
            );
        };

        // --- 3. PORTAL (LANDING) ---
        const Portal = ({ user, users, onSelectApp }) => {
            const [showUserManager, setShowUserManager] = useState(false);
            const isAdmin = user.role === 'admin';
            const p = user.permissions || {};
            const canAccessCRM = isAdmin || p.crm_access;
            const canAccessAttendance = isAdmin || p.att_access;

            return (
                <div className="min-h-screen bg-slate-50 flex flex-col items-center justify-center p-6 relative">
                    {isAdmin && (
                        <div className="absolute top-6 right-6 flex gap-2 z-10">
                            <button onClick={()=>setShowUserManager(true)} className="bg-brand-900 text-white px-5 py-3 rounded-2xl font-bold flex items-center gap-2 shadow-xl hover:bg-brand-800 transition transform hover:scale-105"><Icon name="users" size={20}/> <span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</span></button>
                        </div>
                    )}
                    <div className="max-w-4xl w-full">
                        <div className="flex flex-col md:flex-row justify-between items-center mb-12 gap-6">
                            <div className="flex items-center gap-5"><div className="w-20 h-20 bg-brand-900 rounded-2xl text-white flex items-center justify-center text-3xl font-black shadow-2xl shadow-brand-900/30"><Logo size={60} /></div><div><h1 className="text-3xl font-black text-brand-900 mb-1">Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ {user.name} ğŸ‘‹</h1><p className="text-gray-500 font-medium">{isAdmin ? 'Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…' : 'Ø§Ø®ØªØ± Ø§Ù„Ù†Ø¸Ø§Ù… Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©'}</p></div></div>
                            <button onClick={()=>signOut(auth)} className="text-red-500 bg-red-50 px-6 py-3 rounded-xl font-bold flex items-center gap-2 hover:bg-red-100 transition"><Icon name="log-out"/> <span>Ø®Ø±ÙˆØ¬</span></button>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                            {canAccessCRM ? (
                                <div onClick={() => onSelectApp('crm')} className="portal-card bg-white p-10 rounded-[2rem] shadow-lg border-2 border-transparent hover:border-crm-500 cursor-pointer group relative overflow-hidden"><div className="absolute top-0 left-0 w-full h-2 bg-crm-500"></div><div className="w-24 h-24 bg-crm-500 text-white rounded-3xl flex items-center justify-center mb-8 shadow-2xl shadow-crm-500/30 group-hover:scale-110 transition-transform duration-300"><Icon name="layout-grid" size={48} /></div><h2 className="text-3xl font-black text-gray-800 mb-3">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h2><p className="text-gray-500 leading-relaxed text-lg">Ù†Ø¸Ø§Ù…Ùƒ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØ§Ù„ØµÙÙ‚Ø§Øª ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±.</p><div className="mt-10 flex items-center text-crm-600 font-bold text-lg group-hover:translate-x-2 transition-transform"><span>Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…</span> <Icon name="arrow-left" className="mr-2"/></div></div>
                            ) : ( <div className="bg-gray-50 p-10 rounded-[2rem] border-2 border-dashed border-gray-300 flex flex-col items-center justify-center text-center opacity-60 grayscale cursor-not-allowed"><Icon name="lock" size={48} className="text-gray-400 mb-4"/><h2 className="text-2xl font-bold text-gray-500">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h2><p className="text-gray-400 mt-2">ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„</p></div> )}
                            {canAccessAttendance ? (
                                <div onClick={() => onSelectApp('attendance')} className="portal-card bg-white p-10 rounded-[2rem] shadow-lg border-2 border-transparent hover:border-accent-500 cursor-pointer group relative overflow-hidden"><div className="absolute top-0 left-0 w-full h-2 bg-accent-500"></div><div className="w-24 h-24 bg-accent-500 text-white rounded-3xl flex items-center justify-center mb-8 shadow-2xl shadow-accent-500/30 group-hover:scale-110 transition-transform duration-300"><Icon name="clock" size={48} /></div><h2 className="text-3xl font-black text-gray-800 mb-3">Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù</h2><p className="text-gray-500 leading-relaxed text-lg">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ ÙˆØªØªØ¨Ø¹ Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„.</p><div className="mt-10 flex items-center text-accent-600 font-bold text-lg group-hover:translate-x-2 transition-transform"><span>Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…</span> <Icon name="arrow-left" className="mr-2"/></div></div>
                            ) : ( <div className="bg-gray-50 p-10 rounded-[2rem] border-2 border-dashed border-gray-300 flex flex-col items-center justify-center text-center opacity-60 grayscale cursor-not-allowed"><Icon name="lock" size={48} className="text-gray-400 mb-4"/><h2 className="text-2xl font-bold text-gray-500">Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù</h2><p className="text-gray-400 mt-2">ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„</p></div> )}
                        </div>
                    </div>
                    {showUserManager && <UserManagerMain users={users} currentUser={user} onClose={()=>setShowUserManager(false)} />}
                </div>
            );
        };

        // --- 4. CRM SYSTEM COMPONENTS ---
        const CRMHeader = ({ title, clients, onToggleSidebar }) => {
            const [showNotifs, setShowNotifs] = useState(false);
            const today = new Date().toISOString().slice(0,10);
            const reminders = clients.filter(c => c.nextFollowUp === today);
            const allNotifs = reminders.map(c => ({ type: 'reminder', ...c }));
            return (
                <header className="bg-white border-b p-4 flex justify-between items-center sticky top-0 z-30">
                    <div className="flex items-center gap-2"><button onClick={onToggleSidebar} className="md:hidden text-gray-600 p-1"><Icon name="menu" size={24}/></button><div className="font-bold text-xl text-brand-900">{title}</div></div>
                    <div className="relative"><button onClick={() => setShowNotifs(!showNotifs)} className="p-2 rounded-full hover:bg-gray-100 relative text-gray-600"><Icon name="bell" size={22} />{allNotifs.length > 0 && <span className="absolute top-1 right-1 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white animate-pulse"></span>}</button>{showNotifs && (<><div className="fixed inset-0 z-40" onClick={() => setShowNotifs(false)}></div><div className="absolute left-0 top-full mt-2 w-80 bg-white rounded-xl shadow-xl border z-50 overflow-hidden"><div className="p-3 border-b bg-gray-50 font-bold text-sm text-brand-900 flex justify-between"><span>Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</span><span>{allNotifs.length}</span></div><div className="max-h-64 overflow-y-auto">{allNotifs.length===0?<div className="p-4 text-center text-gray-400 text-xs">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</div>:allNotifs.map((n,i)=><div key={i} className="p-3 border-b hover:bg-gray-50 text-sm"><div className="font-bold">{n.name}</div><div className="text-xs text-gray-500">Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ÙŠÙˆÙ…</div></div>)}</div></div></>)}</div>
                </header>
            );
        };

        const CRMDashboard = ({ clients, currentUser }) => {
            const isAdmin = currentUser.role === 'admin';
            const isSupervisor = currentUser.permissions?.crm_role === 'supervisor';
            const isEmployee = currentUser.permissions?.crm_role === 'employee';

            const relevantClients = clients.filter(c => {
                if (isAdmin || isSupervisor) return true;
                if (isEmployee) return c.assignedTo === currentUser.name;
                return false;
            });

            const totalClients = relevantClients.length; const today = new Date().toISOString().slice(0,10); const reminders = relevantClients.filter(c => c.nextFollowUp === today); const statusData = STATUS_LIST.map(s => ({ name: s.label, count: relevantClients.filter(c => c.status === s.key).length, key: s.key, color: s.color })); const projectStats = {}; relevantClients.forEach(c => safeArr(c.projects).forEach(p => { const n = safeStr(p); if(n) projectStats[n] = (projectStats[n]||0)+1; })); const projectData = Object.entries(projectStats).map(([name, value]) => ({ name, value })); const COLORS = ['#2C3340', '#CE9B52', '#E6BC76', '#94a3b8', '#475569', '#64748b'];
            return (
                <div className="space-y-6"><div className="grid grid-cols-1 md:grid-cols-3 gap-4"><div className="bg-gradient-to-r from-brand-900 to-brand-800 text-white p-6 rounded-2xl shadow-lg flex justify-between items-center"><div><h2 className="text-lg font-bold opacity-80 mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h2><div className="text-4xl font-black">{totalClients}</div></div><div className="bg-white/10 p-4 rounded-full"><Icon name="users" size={32} /></div></div><div className="bg-white p-6 rounded-2xl shadow-lg border border-amber-100 md:col-span-2 relative overflow-hidden"><div className="absolute top-0 left-0 w-full h-1 bg-amber-400"></div><div className="flex justify-between items-start mb-4"><h3 className="font-bold text-brand-900 flex items-center gap-2"><Icon name="bell" className="text-amber-500"/> ØªØ°ÙƒÙŠØ±Ø§Øª Ø§Ù„ÙŠÙˆÙ… ({reminders.length})</h3></div>{reminders.length > 0 ? <div className="flex gap-3 overflow-x-auto pb-2">{reminders.map(c => (<div key={c.id} className="min-w-[200px] bg-gray-50 p-3 rounded-lg border border-gray-100 text-sm"><div className="font-bold text-brand-900 mb-1">{c.name}</div><div className="text-xs text-gray-500 mb-2 date-en">{c.phone}</div></div>))}</div> : <div className="text-center text-gray-400 text-sm py-2">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØªØ§Ø¨Ø¹Ø§Øª</div>}</div></div><div><h3 className="font-bold text-brand-900 mb-4 flex items-center gap-2"><Icon name="activity" size={18}/> Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h3><div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3">{statusData.map(s => (<div key={s.key} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col justify-between hover:shadow-md transition"><div className="text-xs text-gray-500 font-bold mb-2">{s.name}</div><div className="flex justify-between items-end"><div className="text-2xl font-black text-brand-900">{s.count}</div><div className={`w-2 h-2 rounded-full ${s.color.split(' ')[0].replace('bg-', 'bg-')}`}></div></div></div>))}</div></div>{window.Recharts && ( <div className="grid grid-cols-1 lg:grid-cols-2 gap-6"><div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100"><h3 className="font-bold text-brand-900 mb-4 text-sm">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</h3><div className="h-64" dir="ltr"><ResponsiveContainer><PieChart><Pie data={projectData} cx="50%" cy="50%" innerRadius={40} outerRadius={70} paddingAngle={5} dataKey="value">{projectData.map((e,i)=><Cell key={i} fill={COLORS[i%COLORS.length]}/>)}</Pie><Tooltip/><Legend/></PieChart></ResponsiveContainer></div></div><div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100"><h3 className="font-bold text-brand-900 mb-4 text-sm">Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©</h3><div className="h-64" dir="ltr"><ResponsiveContainer><BarChart data={statusData}><CartesianGrid strokeDasharray="3 3" vertical={false}/><XAxis dataKey="name" hide/><YAxis/><Tooltip/><Bar dataKey="count" fill="#2C3340" radius={[4,4,0,0]} barSize={30}/></BarChart></ResponsiveContainer></div></div></div> )}</div>
            );
        };

        const CRMReports = ({ clients, users, currentUser }) => {
            const [startDate, setStartDate] = useState(''); const [endDate, setEndDate] = useState(''); 
            const filteredClients = clients.filter(c => { const d = c.dateAdded ? c.dateAdded.slice(0, 10) : ''; return (startDate ? d >= startDate : true) && (endDate ? d <= endDate : true); }); 
            // Corrected: Report logic strictly based on assignedTo
            const reportData = users.map(u => { const userClients = filteredClients.filter(c => c.assignedTo === u.name); return { id: u.id, name: u.name, total: userClients.length, sold: userClients.filter(c => c.status === 'Sold').length, deposit: userClients.filter(c => c.status === 'Deposit').length, inProgress: userClients.filter(c => ['New','Contacted1','Contacted2','Contacted3'].includes(c.status)).length }; });
            const canExport = currentUser.role === 'admin' || currentUser.permissions?.crm_role === 'supervisor';
            const handleExportReports = () => {
                exportToExcel(reportData, "Employee_Performance_Reports");
            };

            return ( <div className="space-y-6"><div className="bg-white p-4 rounded-xl shadow-sm border flex flex-wrap items-center gap-4"><div className="flex items-center gap-2"><span className="text-sm font-bold text-gray-500">Ù…Ù†:</span><input type="date" className="bg-gray-50 border rounded-lg px-3 py-2 outline-none text-sm date-en" value={startDate} onChange={e=>setStartDate(e.target.value)} /></div><div className="flex items-center gap-2"><span className="text-sm font-bold text-gray-500">Ø¥Ù„Ù‰:</span><input type="date" className="bg-gray-50 border rounded-lg px-3 py-2 outline-none text-sm date-en" value={endDate} onChange={e=>setEndDate(e.target.value)} /></div>{(startDate||endDate)&&<button onClick={()=>{setStartDate('');setEndDate('')}} className="text-xs text-red-500 hover:underline font-bold">Ø¥Ù„ØºØ§Ø¡</button>}{canExport && <button onClick={handleExportReports} className="mr-auto bg-green-600 text-white px-4 py-2 rounded-xl font-bold flex items-center gap-2"><Icon name="file-spreadsheet" size={16}/> ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>}</div><div className="bg-white rounded-xl shadow-sm border overflow-hidden"><table className="w-full text-right"><thead className="bg-gray-50 text-sm font-bold text-brand-900"><tr><th className="p-4">Ø§Ù„Ù…ÙˆØ¸Ù (Ø§Ù„Ù…Ø³Ù†Ø¯ Ø¥Ù„ÙŠÙ‡)</th><th className="p-4 text-center">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</th><th className="p-4 text-center text-emerald-600">ØªÙ… Ø§Ù„Ø¨ÙŠØ¹</th><th className="p-4 text-center text-amber-600">Ø¹Ø±Ø¨ÙˆÙ†</th><th className="p-4 text-center text-blue-600">Ù‚ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</th></tr></thead><tbody className="divide-y">{reportData.map(r=><tr key={r.id} className="hover:bg-gray-50"><td className="p-4"><div className="font-bold text-brand-900">{r.name}</div></td><td className="p-4 text-center font-bold">{r.total}</td><td className="p-4 text-center font-bold text-emerald-600">{r.sold}</td><td className="p-4 text-center font-bold text-amber-600">{r.deposit}</td><td className="p-4 text-center font-bold text-blue-600">{r.inProgress}</td></tr>)}</tbody></table></div></div> );
        };

        const CRMClientList = ({ clients, users, currentUser, onAdd, onEdit, onImport }) => {
            const [search, setSearch] = useState(''); const [filterStatus, setFilterStatus] = useState(''); const [filterAssignee, setFilterAssignee] = useState(''); const [itemsPerPage, setItemsPerPage] = useState(10); const [currentPage, setCurrentPage] = useState(1); const [deleteId, setDeleteId] = useState(null); const assignees = useMemo(() => [...new Set(clients.map(c => c.assignedTo).filter(Boolean))], [clients]);
            const filtered = clients.filter(c => { 
                if(currentUser.role !== 'admin' && currentUser.permissions?.crm_role === 'employee' && c.assignedTo !== currentUser.name && c.addedBy !== currentUser.email) return false;
                const s = safeStr(search).toLowerCase(); 
                return (safeStr(c.name).toLowerCase().includes(s) || safeStr(c.phone).includes(s)) && (filterStatus ? c.status === filterStatus : true) && (filterAssignee ? c.assignedTo === filterAssignee : true); 
            });
            useEffect(() => { setCurrentPage(1); }, [search, filterStatus, filterAssignee, itemsPerPage]); 
            const displayedClients = itemsPerPage === 'All' ? filtered : filtered.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage); 
            const isAdmin = currentUser.role === 'admin'; const isSupervisor = currentUser.permissions?.crm_role === 'supervisor'; const canDelete = isAdmin || isSupervisor; const canExport = isAdmin; 
            const handleExport = () => { const excelData = filtered.map(c => ({ 'Ø§Ù„Ø§Ø³Ù…': c.name, 'Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ': c.phone, 'Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹': safeArr(c.projects).join(', '), 'Ø§Ù„Ø­Ø§Ù„Ø©': STATUS_LIST.find(s=>s.key===c.status)?.label||c.status, 'Ø§Ù„Ù…ÙˆØ¸Ù': c.assignedTo||'-', 'Ø§Ù„Ù…Ù†Ø´Ø¦': c.addedBy||'-', 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¶Ø§ÙØ©': c.dateAdded ? new Date(c.dateAdded).toLocaleDateString('en-GB') : '-' })); exportToExcel(excelData, "Clients"); }; 
            const handleImportFile = (e) => { const file = e.target.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = (evt) => { const bstr = evt.target.result; const wb = XLSX.read(bstr, {type:'binary'}); const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]); onImport(data); }; reader.readAsBinaryString(file); }; 
            const confirmDelete = () => { if(deleteId) { remove(ref(db, `clients/${deleteId}`)); setDeleteId(null); } };
            
            return (
                <div className="space-y-4">
                    <div className="flex justify-between items-center flex-wrap gap-4">
                        <div className="flex gap-2 flex-wrap mr-auto">
                            {canExport && (<><div className="relative overflow-hidden"><button className="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-xl font-bold flex items-center gap-2"><Icon name="upload" size={18}/> Ø§Ø³ØªÙŠØ±Ø§Ø¯</button><input type="file" accept=".xlsx" onChange={handleImportFile} className="absolute inset-0 opacity-0 cursor-pointer"/></div><button onClick={handleExport} className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-xl font-bold flex items-center gap-2"><Icon name="file-spreadsheet" size={18}/> ØªØµØ¯ÙŠØ±</button></>)}
                            <button onClick={onAdd} className="bg-brand-900 hover:bg-brand-800 text-white px-4 py-2 rounded-xl font-bold flex items-center gap-2"><Icon name="plus" size={18}/> Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„</button>
                        </div>
                    </div>
                    <div className="bg-white p-3 rounded-xl shadow-sm border flex flex-wrap gap-2 items-center"><input className="flex-1 bg-gray-50 rounded-lg px-3 py-2 outline-none min-w-[150px] text-sm" placeholder="Ø¨Ø­Ø«..." value={search} onChange={e=>setSearch(e.target.value)} /><select className="bg-gray-50 rounded-lg px-3 py-2 outline-none text-sm" value={filterStatus} onChange={e=>setFilterStatus(e.target.value)}><option value="">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>{STATUS_LIST.map(s=><option key={s.key} value={s.key}>{s.label}</option>)}</select><select className="bg-gray-50 rounded-lg px-3 py-2 outline-none text-sm" value={filterAssignee} onChange={e=>setFilterAssignee(e.target.value)}><option value="">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</option>{assignees.map(a=><option key={a} value={a}>{a}</option>)}</select></div>
                    <div className="bg-white rounded-xl shadow-sm border overflow-hidden"><div className="overflow-x-auto"><table className="w-full text-right"><thead className="bg-gray-50 text-sm font-bold text-brand-900"><tr><th className="p-4">Ø§Ù„Ø§Ø³Ù…</th><th className="p-4">Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</th><th className="p-4">Ø§Ù„Ø­Ø§Ù„Ø©</th><th className="p-4">Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø³Ù†Ø¯</th><th className="p-4">Ø§Ù„Ù…Ù†Ø´Ø¦</th><th className="p-4">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¶Ø§ÙØ©</th><th className="p-4">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</th><th className="p-4"></th></tr></thead><tbody className="divide-y">{displayedClients.length > 0 ? displayedClients.map(c => (<tr key={c.id} className="hover:bg-gray-50 group"><td className="p-4"><div className="font-bold text-brand-900">{safeStr(c.name)}</div><div className="flex items-center gap-2 mt-1"><span className="text-xs text-gray-500 date-en">{safeStr(c.phone)}</span><a href={`https://wa.me/966${safeStr(c.phone).substring(1)}`} target="_blank" className="bg-green-50 text-green-600 p-1.5 rounded-full"><Icon name="message-circle" size={14} /></a><a href={`tel:${safeStr(c.phone)}`} className="bg-blue-50 text-blue-600 p-1.5 rounded-full"><Icon name="phone" size={14} /></a></div></td><td className="p-4 text-sm text-gray-600">{safeArr(c.projects).map((p,i)=><div key={i}>â€¢ {safeStr(p)}</div>)}</td><td className="p-4"><span className={`px-2 py-1 rounded text-xs border ${STATUS_LIST.find(s=>s.key===c.status)?.color}`}>{STATUS_LIST.find(s=>s.key===c.status)?.label}</span></td><td className="p-4 text-sm text-gray-600">{safeStr(c.assignedTo)}</td><td className="p-4 text-sm text-gray-500">{safeStr(c.addedBy)}</td><td className="p-4 text-sm text-gray-500 date-en">{c.dateAdded ? new Date(c.dateAdded).toLocaleDateString('en-GB') : '-'}</td><td className="p-4 text-xs text-amber-600 font-bold date-en">{c.nextFollowUp||'-'}</td><td className="p-4 flex items-center gap-2"><button onClick={()=>onEdit(c)} className="text-brand-900 hover:bg-gray-100 p-2 rounded"><Icon name="edit" size={16}/></button>{canDelete && <button onClick={()=>setDeleteId(c.id)} className="text-red-500 hover:bg-red-50 p-2 rounded"><Icon name="trash-2" size={16}/></button>}</td></tr>)) : <tr><td colSpan="8" className="p-8 text-center text-gray-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</td></tr>}</tbody></table></div></div>
                    {deleteId && <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"><div className="bg-white p-6 rounded-xl shadow-lg max-w-sm w-full text-center"><h3 className="text-lg font-bold mb-2">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ</h3><div className="flex gap-3 justify-center mt-4"><button onClick={confirmDelete} className="bg-red-600 text-white px-4 py-2 rounded-lg">Ø­Ø°Ù</button><button onClick={()=>setDeleteId(null)} className="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg">Ø¥Ù„ØºØ§Ø¡</button></div></div></div>}
                </div>
            );
        };

        const CRMClientModal = ({ isOpen, onClose, client, onSave, users, currentUser }) => {
            const [d, setD] = useState({ name: '', phone: '', projects: [], status: 'New', assignedTo: currentUser.role==='employee'?currentUser.name:'', source: 'Ù…Ø¨Ø§Ø´Ø±', nextFollowUp: '', history: [] }); 
            const [newNote, setNewNote] = useState(''); 
            const [notes, setNotes] = useState([]); 
            const notesEndRef = useRef(null);
            const [activeTab, setActiveTab] = useState('notes'); // New state for tabs
            
            useEffect(() => { 
                if(client) { 
                    setD({ ...client, history: client.history ? Object.values(client.history) : [] }); 
                    setNotes(client.notes ? Object.values(client.notes) : []); 
                } else { 
                    setD({ name: '', phone: '', projects: [], status: 'New', assignedTo: currentUser.role==='employee'?currentUser.name:'', source: 'Ù…Ø¨Ø§Ø´Ø±', nextFollowUp: '', history: [] }); 
                    setNotes([]); 
                } 
            }, [client]); 
            
            useEffect(() => { notesEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [notes, isOpen]);
            
            const toggleProject = (p) => { const curr = safeArr(d.projects); setD({ ...d, projects: curr.includes(p) ? curr.filter(x=>x!==p) : [...curr, p] }); };
            
            const handleAddNote = () => { 
                if(!newNote.trim()) return; 
                const noteData = { text: newNote, date: new Date().toISOString(), author: currentUser.name }; 
                setNotes([...notes, noteData]); 
                // Log the action
                const logData = { action: 'Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø©', user: currentUser.name, date: new Date().toISOString() };
                setD(prev => ({...prev, history: [...(prev.history||[]), logData]}));
                
                if(client) {
                    push(ref(db, `clients/${client.id}/notes`), noteData);
                    push(ref(db, `clients/${client.id}/history`), logData);
                } 
                setNewNote(''); 
            };
            
            const handleSaveInternal = () => {
                // Determine log action
                let logAction = 'ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
                if (!client) logAction = 'Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯';
                else if (d.status !== client.status) logAction = `ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰ ${STATUS_LIST.find(s=>s.key===d.status)?.label}`;
                else if (d.assignedTo !== client.assignedTo) logAction = `Ø¥Ø³Ù†Ø§Ø¯ Ø¥Ù„Ù‰ ${d.assignedTo}`;

                const logData = { action: logAction, user: currentUser.name, date: new Date().toISOString() };
                const updatedHistory = [...(d.history||[]), logData];
                
                onSave(client ? d : { ...d, history: updatedHistory, notes: notes }, logData);
            };

            const canAssign = currentUser.role === 'admin' || currentUser.role === 'supervisor';
            
            return ( 
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                    <div className="bg-white w-full max-w-3xl rounded-2xl p-6 shadow-2xl max-h-[90vh] overflow-y-auto grid grid-cols-1 md:grid-cols-2 gap-6">
                        
                        {/* Column 1: Client Details (Inputs) */}
                        <div className="space-y-4">
                            <h3 className="font-bold text-lg">{client?'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„':'Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„'}</h3>
                            <input className="w-full bg-gray-50 border rounded-lg p-3" placeholder="Ø§Ù„Ø§Ø³Ù…" value={safeStr(d.name)} onChange={e=>setD({...d, name:e.target.value})} />
                            <input className="w-full bg-gray-50 border rounded-lg p-3 date-en text-right" placeholder="05xxxxxxxx" value={safeStr(d.phone)} onChange={e=>setD({...d, phone:e.target.value})} />
                            
                            <div>
                                <label className="text-xs font-bold block mb-2">Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</label>
                                <div className="grid grid-cols-2 gap-2">{PROJECT_LIST.map(p => (<button key={p} onClick={()=>toggleProject(p)} className={`p-2 rounded text-xs border ${safeArr(d.projects).includes(p)?'bg-brand-900 text-white':'bg-white'}`}>{p}</button>))}</div>
                            </div>
                            
                            <select className="w-full bg-gray-50 border rounded-lg p-3" value={safeStr(d.source)} onChange={e=>setD({...d, source:e.target.value})}>{CLIENT_SOURCES.map(s=><option key={s} value={s}>{s}</option>)}</select>
                            <input className="w-full bg-gray-50 border rounded-lg p-3" placeholder="Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©" value={safeStr(d.unitNumber)} onChange={e=>setD({...d, unitNumber:e.target.value})} />
                            <select className="w-full bg-gray-50 border rounded-lg p-3" value={safeStr(d.status)} onChange={e=>setD({...d, status:e.target.value})}>{STATUS_LIST.map(s=><option key={s.key} value={s.key}>{s.label}</option>)}</select>
                            <select className="w-full bg-gray-50 border rounded-lg p-3 disabled:opacity-50" value={safeStr(d.assignedTo)} onChange={e=>setD({...d, assignedTo:e.target.value})} disabled={!canAssign}><option value="">Ø¨Ø¯ÙˆÙ† Ø¥Ø³Ù†Ø§Ø¯</option>{users.map(u=><option key={u.id} value={u.name}>{u.name}</option>)}</select>
                            
                            <div>
                                <label className="text-xs font-bold block mb-1 text-amber-600">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…</label>
                                <input type="date" className="w-full bg-amber-50 border border-amber-200 rounded-lg p-3 date-en" value={d.nextFollowUp || ''} onChange={e=>setD({...d, nextFollowUp:e.target.value})} />
                            </div>
                            
                        </div>
                        
                        {/* Column 2: Tabs (Notes & History) */}
                        <div className="flex flex-col h-full">
                            
                            {/* Tab Header */}
                            <div className="flex justify-between items-center mb-4 border-b">
                                <div className="flex gap-4">
                                    <button onClick={() => setActiveTab('notes')} className={`font-bold text-lg pb-2 transition ${activeTab === 'notes' ? 'text-brand-900 border-b-2 border-brand-900' : 'text-gray-500'}`}>
                                        <Icon name="notebook-pen" size={18} className="inline-block ml-2"/> Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
                                    </button>
                                    <button onClick={() => setActiveTab('history')} className={`font-bold text-lg pb-2 transition ${activeTab === 'history' ? 'text-brand-900 border-b-2 border-brand-900' : 'text-gray-500'}`}>
                                        <Icon name="history" size={18} className="inline-block ml-2"/> Ø³Ø¬Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
                                    </button>
                                </div>
                                <button onClick={onClose} className="md:hidden p-1"><Icon name="x"/></button>
                            </div>

                            {/* Notes Tab Content */}
                            {activeTab === 'notes' && (
                                <div className="flex-1 flex flex-col min-h-0">
                                    <div className="flex-1 bg-gray-50 border rounded-xl p-4 mb-4 overflow-y-auto max-h-[400px] space-y-3">
                                        {notes.length === 0 && <div className="text-center text-gray-400 text-sm mt-10">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¨Ø¹Ø¯</div>}
                                        {notes.map((n, i) => (
                                            <div key={i} className="bg-white p-3 rounded-lg border shadow-sm text-sm">
                                                <p className="text-gray-800 mb-2">{n.text}</p>
                                                <div className="flex justify-between text-xs text-gray-400">
                                                    <span>{n.author}</span>
                                                    <span className="date-en">{new Date(n.date).toLocaleDateString('en-GB')} {new Date(n.date).toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' })}</span>
                                                </div>
                                            </div>
                                        ))}
                                        <div ref={notesEndRef} />
                                    </div>
                                    <div className="flex gap-2 mb-6">
                                        <input className="flex-1 border rounded-lg p-2 text-sm" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø©..." value={newNote} onChange={e=>setNewNote(e.target.value)} onKeyPress={e=>e.key==='Enter'&&handleAddNote()} />
                                        <button onClick={handleAddNote} className="bg-gray-200 hover:bg-gray-300 p-2 rounded-lg"><Icon name="send" size={16}/></button>
                                    </div>
                                </div>
                            )}

                            {/* History Tab Content */}
                            {activeTab === 'history' && client && (
                                <div className="flex-1 bg-gray-50 border rounded-xl p-4 mb-4 overflow-y-auto max-h-[400px]">
                                    <div className="text-xs space-y-2">
                                        {safeArr(d.history).slice().reverse().map((h, i) => (
                                            <div key={i} className="flex justify-between items-start border-b pb-2 last:border-0 last:pb-0">
                                                <span className="font-bold text-gray-700 w-3/5">{h.action}</span>
                                                <div className="text-gray-500 text-left w-2/5">
                                                    <div className='text-[11px]'>{h.user}</div>
                                                    <div className="date-en text-[10px] text-gray-400">
                                                        {new Date(h.date).toLocaleDateString('en-GB')} 
                                                        <span className='mr-1'>{new Date(h.date).toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' })}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                        {safeArr(d.history).length === 0 && <div className="text-center text-gray-400 text-sm mt-10">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ø£Ø­Ø¯Ø§Ø« Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„.</div>}
                                    </div>
                                </div>
                            )}

                            {/* Action Buttons (fixed at the bottom) */}
                            <div className="mt-auto flex gap-3">
                                <button onClick={onClose} className="flex-1 bg-gray-100 text-gray-700 py-3 rounded-lg font-bold hover:bg-gray-200">Ø¥Ù„ØºØ§Ø¡</button>
                                <button onClick={handleSaveInternal} className="flex-1 bg-brand-900 text-white py-3 rounded-lg font-bold hover:bg-brand-800 shadow-lg">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                            </div>
                        </div>

                    </div>
                </div>
            );
        };
        
        const CRMBackup = ({ clients, users, onImport }) => {
             const handleImportFile = (e) => { const file = e.target.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = (evt) => { const bstr = evt.target.result; const wb = XLSX.read(bstr, {type:'binary'}); const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]); onImport(data); }; reader.readAsBinaryString(file); }; 
             const downloadTemplate = () => {
                 const headers = [{ 'Ø§Ù„Ø§Ø³Ù…': 'Ø§Ø³Ù… ØªØ¬Ø±ÙŠØ¨ÙŠ', 'Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ': '0500000000', 'Ø§Ù„Ù…Ø´Ø±ÙˆØ¹': 'Ø¨ÙŠÙˆØªÙƒÙ… 10' }];
                 exportToExcel(headers, "Import_Template");
             };

             return ( 
                <div className="bg-white p-6 rounded-xl shadow-sm border space-y-4">
                    <h3 className="font-bold text-lg mb-4">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
                    <button onClick={() => { const data = { clients, users, date: new Date().toISOString() }; const blob = new Blob([JSON.stringify(data)], { type: "application/json" }); const url = URL.createObjectURL(blob); const link = document.createElement("a"); link.href = url; link.download = "backup.json"; link.click(); }} className="w-full bg-brand-900 text-white p-4 rounded-xl flex justify-center gap-2 font-bold"><Icon name="download" /> ØªØ­Ù…ÙŠÙ„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙƒØ§Ù…Ù„Ø© (JSON)</button>
                    <div className="h-px bg-gray-100 my-4"></div>
                    <h3 className="font-bold text-lg mb-4">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h3>
                    <div className="grid grid-cols-2 gap-4">
                        <button onClick={downloadTemplate} className="w-full bg-gray-100 text-gray-700 p-4 rounded-xl flex justify-center gap-2 font-bold hover:bg-gray-200 transition"><Icon name="file-spreadsheet" /> ØªØ­Ù…ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
                        <div className="relative overflow-hidden w-full">
                            <button className="w-full bg-indigo-600 text-white p-4 rounded-xl flex justify-center gap-2 font-bold hover:bg-indigo-700 transition"><Icon name="upload" /> Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (Excel)</button>
                            <input type="file" accept=".xlsx" onChange={handleImportFile} className="absolute inset-0 opacity-0 cursor-pointer"/>
                        </div>
                    </div>
                </div> 
            );
        };

        // --- 5. CRM APP CONTAINER ---
        const CRMApp = ({ user, clients, users, onSaveClient, onImport, onBack }) => {
            const [page, setPage] = useState('dashboard'); const [modalOpen, setModalOpen] = useState(false); const [editClient, setEditClient] = useState(null); const [sidebarOpen, setSidebarOpen] = useState(false);
            const getPageTitle = () => { switch(page) { case 'dashboard': return 'Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…'; case 'clients': return 'Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØ§Ù„Ø·Ù„Ø¨Ø§Øª'; case 'reports': return 'Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±'; case 'backup': return 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª'; default: return ''; }};
            const isAdmin = user.role === 'admin'; const isSupervisor = user.permissions?.crm_role === 'supervisor'; const canSeeReports = isAdmin || isSupervisor || user.permissions?.crm_reports; const canBackup = isAdmin; 
            return ( <div className="flex min-h-screen bg-slate-50"><aside className={`fixed md:sticky top-0 h-screen w-72 bg-white border-l z-50 transition-transform ${sidebarOpen ? 'translate-x-0' : 'translate-x-full md:translate-x-0'}`}><div className="p-6 h-full flex flex-col"><div className="flex items-center gap-2 mb-8 text-brand-900 font-black text-xl"><Logo size={40} /> Ø¨ÙŠÙˆØªÙƒÙ…</div><nav className="flex-1 space-y-1"><button onClick={()=>{setPage('dashboard');setSidebarOpen(false)}} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold transition ${page==='dashboard'?'bg-brand-900 text-white':'text-gray-500 hover:bg-gray-50'}`}><Icon name="layout-dashboard"/> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button><button onClick={()=>{setPage('clients');setSidebarOpen(false)}} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold transition ${page==='clients'?'bg-brand-900 text-white':'text-gray-500 hover:bg-gray-50'}`}><Icon name="users"/> Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</button>{canSeeReports && (<button onClick={()=>{setPage('reports');setSidebarOpen(false)}} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold transition ${page==='reports'?'bg-brand-900 text-white':'text-gray-500 hover:bg-gray-50'}`}><Icon name="bar-chart-2"/> Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>)}{canBackup && (<button onClick={()=>{setPage('backup');setSidebarOpen(false)}} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold transition ${page==='backup'?'bg-brand-900 text-white':'text-gray-500 hover:bg-gray-50'}`}><Icon name="settings"/> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>)}</nav><div className="border-t pt-4 mt-auto"><button onClick={onBack} className="w-full bg-gray-50 border border-gray-200 text-gray-700 p-2 rounded-lg font-bold flex items-center justify-center gap-2 hover:bg-gray-100 transition mb-4"><Icon name="grid" size={16}/> ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</button><div className="flex items-center gap-2 mb-4"><div className="w-8 h-8 rounded-full bg-brand-900 text-white flex items-center justify-center text-xs">{safeStr(user.name).charAt(0)}</div><div><div className="text-sm font-bold text-brand-900">{safeStr(user.name)}</div><div className="text-xs text-gray-500">{user.role==='admin'?'Ù…Ø³Ø¤ÙˆÙ„':user.permissions?.crm_role==='supervisor'?'Ù…Ø´Ø±Ù':'Ù…ÙˆØ¸Ù'}</div></div></div></div></div></aside><main className="flex-1 flex flex-col h-screen overflow-hidden"><CRMHeader title={page==='dashboard'?'Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…':page==='clients'?'Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡':page==='reports'?'Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±':'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª'} clients={clients} onToggleSidebar={()=>setSidebarOpen(true)} /><div className="flex-1 overflow-y-auto p-6"><div className="max-w-5xl mx-auto">{page === 'dashboard' && <CRMDashboard clients={clients} currentUser={user} />}{page === 'clients' && <CRMClientList clients={clients} users={users} currentUser={user} onAdd={()=>{setEditClient(null);setModalOpen(true)}} onEdit={(c)=>{setEditClient(c);setModalOpen(true)}} onImport={onImport} />}{page === 'reports' && canSeeReports && <CRMReports clients={clients} users={users} currentUser={user} />}{page === 'backup' && canBackup && <CRMBackup clients={clients} users={users} onImport={onImport} />}</div></div></main>{modalOpen && <CRMClientModal isOpen={modalOpen} onClose={()=>setModalOpen(false)} client={editClient} onSave={(d, log)=>{onSaveClient(d, editClient, log);setModalOpen(false)}} users={users} currentUser={user} />}</div> );
        };

        // --- 6. ATTENDANCE SYSTEM ---
        const MapZoneEditor = ({ center, radius, onChange }) => { const mapRef = useRef(null); const mapObj = useRef(null); const markerObj = useRef(null); const circleObj = useRef(null); useEffect(() => { if (!mapRef.current) return; if (!mapObj.current) { mapObj.current = L.map(mapRef.current).setView([center.lat, center.lng], 15); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapObj.current); const icon = L.icon({ iconUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon.png', shadowUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41] }); markerObj.current = L.marker([center.lat, center.lng], { icon, draggable: true }).addTo(mapObj.current); circleObj.current = L.circle([center.lat, center.lng], { color: '#CE9B52', fillColor: '#CE9B52', fillOpacity: 0.2, radius: radius }).addTo(mapObj.current); const update = (lat, lng) => { markerObj.current.setLatLng([lat, lng]); circleObj.current.setLatLng([lat, lng]); onChange({ lat, lng }, radius); }; mapObj.current.on('click', (e) => update(e.latlng.lat, e.latlng.lng)); markerObj.current.on('dragend', (e) => { const l = e.target.getLatLng(); update(l.lat, l.lng); }); } }, []); useEffect(() => { if(circleObj.current) circleObj.current.setRadius(radius); }, [radius]); return <div ref={mapRef} className="w-full h-64 rounded-xl z-0" />; };
        const calculateDistance = (lat1, lon1, lat2, lon2) => { const R = 6371e3; const Ï†1 = lat1 * Math.PI/180; const Ï†2 = lat2 * Math.PI/180; const Î”Ï† = (lat2-lat1) * Math.PI/180; const Î”Î» = (lon2-lon1) * Math.PI/180; const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) + Math.cos(Ï†1) * Math.cos(Ï†2) * Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2); return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); };

        // -- Zone Modal --
        const ZoneModal = ({ isOpen, onClose, users, zones, onSave, zoneToEdit }) => {
            const [zone, setZone] = useState({ name: '', startTime: '08:00', endTime: '16:00', lat: 24.7136, lng: 46.6753, radius: 200, assignedUsers: [] });
            
            useEffect(() => { if (isOpen) { if (zoneToEdit) setZone(zoneToEdit); else setZone({ name: '', startTime: '08:00', endTime: '16:00', lat: 24.7136, lng: 46.6753, radius: 200, assignedUsers: [] }); } }, [isOpen, zoneToEdit]);
            if(!isOpen) return null;

            const toggleUser = (uid) => {
                const current = safeArr(zone.assignedUsers);
                const otherZones = zones.filter(z => z.id !== (zone.id || 'new')); // Exclude current zone if editing
                const isAssignedElsewhere = otherZones.some(z => safeArr(z.assignedUsers).includes(uid));
                
                if (isAssignedElsewhere && !current.includes(uid)) {
                    return alert("Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¸Ù Ù…Ø³Ø¬Ù„ ÙÙŠ Ù†Ø·Ø§Ù‚ Ø¢Ø®Ø± Ø¨Ø§Ù„ÙØ¹Ù„. Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ³Ø¬ÙŠÙ„Ù‡ ÙÙŠ Ù†Ø·Ø§Ù‚ÙŠÙ†.");
                }
                setZone({...zone, assignedUsers: current.includes(uid) ? current.filter(id=>id!==uid) : [...current, uid] });
            };

            return (
                <div className="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4">
                    <div className="bg-white w-full max-w-2xl rounded-2xl p-6 shadow-2xl max-h-[90vh] overflow-y-auto animate-in fade-in slide-in-from-bottom-4">
                        <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-lg">{zoneToEdit ? 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†Ø·Ø§Ù‚' : 'Ø¥Ø¶Ø§ÙØ© Ù†Ø·Ø§Ù‚ Ø¬Ø¯ÙŠØ¯'}</h3><button onClick={onClose}><Icon name="x"/></button></div>
                        <div className="grid md:grid-cols-2 gap-4 mb-4">
                            <input className="border p-2 rounded-lg" placeholder="Ø§Ø³Ù… Ø§Ù„Ù†Ø·Ø§Ù‚ (Ù…Ø«Ù„Ø§Ù‹: Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ)" value={zone.name} onChange={e=>setZone({...zone, name:e.target.value})}/>
                            <div className="flex gap-2">
                                <div className="flex-1"><label className="text-xs block">Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ù…</label><input type="time" className="w-full border p-2 rounded-lg" value={zone.startTime} onChange={e=>setZone({...zone, startTime:e.target.value})}/></div>
                                <div className="flex-1"><label className="text-xs block">Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ù…</label><input type="time" className="w-full border p-2 rounded-lg" value={zone.endTime} onChange={e=>setZone({...zone, endTime:e.target.value})}/></div>
                            </div>
                        </div>
                        <div className="mb-4">
                             <label className="text-xs block mb-1 font-bold">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆØ§Ù„Ù‚Ø·Ø± ({zone.radius}Ù…)</label>
                             <MapZoneEditor center={{lat: zone.lat, lng: zone.lng}} radius={zone.radius} onChange={(c, r) => setZone({...zone, lat: c.lat, lng: c.lng, radius: r})} />
                             <input type="range" min="50" max="2000" step="50" className="w-full mt-2 accent-accent-600" value={zone.radius} onChange={e=>setZone({...zone, radius: Number(e.target.value)})} />
                        </div>
                        <div className="mb-4 border-t pt-4">
                            <label className="font-bold block mb-2">Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ù…ØµØ±Ø­ Ù„Ù‡Ù… ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù†Ø·Ø§Ù‚:</label>
                            <div className="grid grid-cols-2 gap-2 max-h-32 overflow-y-auto p-2 border rounded-lg bg-gray-50">
                                {users.filter(u => u.id !== 'admin').map(u => {
                                    const isAssignedHere = safeArr(zone.assignedUsers).includes(u.id);
                                    const otherZones = zones.filter(z => z.id !== (zone.id || 'new'));
                                    const isAssignedElsewhere = otherZones.some(z => safeArr(z.assignedUsers).includes(u.id));
                                    return (
                                        <label key={u.id} className={`flex items-center gap-2 p-2 rounded border cursor-pointer ${isAssignedElsewhere ? 'bg-gray-100 opacity-50 cursor-not-allowed' : 'bg-white hover:bg-gray-100'}`}>
                                            <input type="checkbox" checked={isAssignedHere} onChange={()=>toggleUser(u.id)} disabled={isAssignedElsewhere} className="accent-accent-600"/>
                                            <span className="text-sm">{u.name} {isAssignedElsewhere && '(Ù…Ø³Ø¬Ù„ Ø¨Ù†Ø·Ø§Ù‚ Ø¢Ø®Ø±)'}</span>
                                        </label>
                                    );
                                })}
                            </div>
                        </div>
                        <button onClick={() => onSave(zone)} className="w-full bg-accent-600 text-white py-3 rounded-xl font-bold">Ø­ÙØ¸ Ø§Ù„Ù†Ø·Ø§Ù‚</button>
                    </div>
                </div>
            );
        };

        // -- Advanced Reports Component --
        const AttendanceReports = ({ logs, users, zones }) => {
            const [startDate, setStartDate] = useState('');
            const [endDate, setEndDate] = useState('');
            
            const reportData = logs.slice().reverse().filter(l => {
                const logDate = l.timestamp.slice(0, 10);
                return (!startDate || logDate >= startDate) && (!endDate || logDate <= endDate);
            }).reduce((acc, log) => {
                const date = log.timestamp.slice(0, 10);
                const key = `${log.uid}-${date}`;
                if (!acc[key]) acc[key] = { uid: log.uid, date: date, user: users.find(u=>u.id===log.uid)?.name, checkIn: '-', checkOut: '-', late: 0, early: 0, hours: 0 };
                if (log.type === 'IN') acc[key].checkIn = log.timestamp;
                if (log.type === 'OUT') acc[key].checkOut = log.timestamp;
                return acc;
            }, {});

            const processedRows = Object.values(reportData).map(row => {
                let lateText = '-', earlyText = '-', hoursText = '-', deduction = '-';
                const zone = zones.find(z => safeArr(z.assignedUsers).includes(row.uid));

                if (row.checkIn !== '-' && zone) {
                    const shiftStart = new Date(`${row.date}T${zone.startTime}`);
                    const actualIn = new Date(row.checkIn);
                    const diffLate = (actualIn - shiftStart) / 60000; 
                    if (diffLate > 15) {
                        lateText = `${Math.round(diffLate)} Ø¯Ù‚ÙŠÙ‚Ø©`;
                        if (diffLate > 60) deduction = 'Ø®ØµÙ… ÙŠÙˆÙ…';
                        else if (diffLate > 30) deduction = 'Ø®ØµÙ… Ù†ØµÙ ÙŠÙˆÙ…';
                        else deduction = 'ØªÙ†Ø¨ÙŠÙ‡ (ØªØ£Ø®ÙŠØ±)';
                    }
                }
                if (row.checkOut !== '-' && zone) {
                    const shiftEnd = new Date(`${row.date}T${zone.endTime}`);
                    const actualOut = new Date(row.checkOut);
                    const diffEarly = (shiftEnd - actualOut) / 60000;
                    if (diffEarly > 0) earlyText = `${Math.round(diffEarly)} Ø¯Ù‚ÙŠÙ‚Ø©`;
                }
                if (row.checkIn !== '-' && row.checkOut !== '-') hoursText = calculateDuration(row.checkIn, row.checkOut);
                return { ...row, lateText, earlyText, hoursText, deduction };
            });

            return (
                <div className="space-y-4">
                    <div className="bg-white p-4 rounded-xl shadow-sm border flex flex-wrap gap-4 items-center">
                        <div className="flex items-center gap-2"><span className="font-bold text-gray-600 text-sm">Ù…Ù†:</span><input type="date" className="border rounded-lg p-2 text-sm" value={startDate} onChange={e=>setStartDate(e.target.value)} /></div>
                        <div className="flex items-center gap-2"><span className="font-bold text-gray-600 text-sm">Ø¥Ù„Ù‰:</span><input type="date" className="border rounded-lg p-2 text-sm" value={endDate} onChange={e=>setEndDate(e.target.value)} /></div>
                        {(startDate || endDate) && <button onClick={()=>{setStartDate('');setEndDate('')}} className="text-xs text-red-500 font-bold">Ù…Ø³Ø­</button>}
                        <button onClick={()=>exportToExcel(processedRows, 'Attendance')} className="mr-auto bg-green-600 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2 text-sm"><Icon name="file-spreadsheet" size={16}/> ØªØµØ¯ÙŠØ±</button>
                    </div>
                    <div className="bg-white rounded-xl shadow-sm border overflow-hidden"><table className="w-full text-right text-sm"><thead className="bg-gray-50 text-brand-900 font-bold"><tr><th className="p-3">Ø§Ù„Ù…ÙˆØ¸Ù</th><th className="p-3">Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th className="p-3">Ø¯Ø®ÙˆÙ„</th><th className="p-3 text-red-600">ØªØ£Ø®ÙŠØ±</th><th className="p-3">Ø®Ø±ÙˆØ¬</th><th className="p-3 text-orange-600">Ù…Ø¨ÙƒØ±</th><th className="p-3 font-black">Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„</th><th className="p-3 text-red-800">Ø§Ù„Ø¬Ø²Ø§Ø¡ / Ø§Ù„Ø®ØµÙ…</th></tr></thead><tbody className="divide-y">{processedRows.map((r, i) => (<tr key={i} className="hover:bg-gray-50"><td className="p-3 font-bold">{r.user}</td><td className="p-3 date-en">{r.date}</td><td className="p-3 date-en">{r.checkIn !== '-' ? formatTime(r.checkIn) : '-'}</td><td className="p-3 text-red-600 font-bold">{r.lateText}</td><td className="p-3 date-en">{r.checkOut !== '-' ? formatTime(r.checkOut) : '-'}</td><td className="p-3 text-orange-600 font-bold">{r.earlyText}</td><td className="p-3 font-black bg-gray-50">{r.hoursText}</td><td className="p-3 text-red-800 text-xs font-bold">{r.deduction}</td></tr>))}</tbody></table></div></div>
            );
        };

        // -- Main Attendance App --
        const AttendanceApp = ({ user, zones, usersList, logs, onBack }) => {
            const isAdmin = user.role === 'admin'; const isSupervisor = user.permissions?.att_role === 'supervisor'; 
            const canSeeReports = isAdmin || isSupervisor || user.permissions?.att_reports; const canManageZones = isAdmin || user.permissions?.att_zones;
            const [page, setPage] = useState(canSeeReports ? 'live' : 'my_attendance'); const [modalOpen, setModalOpen] = useState(false); const [editingZone, setEditingZone] = useState(null);
            const [myStatus, setMyStatus] = useState('loading'); const [currentZone, setCurrentZone] = useState(null); const [todayLog, setTodayLog] = useState({ in: null, out: null });
            
            useEffect(() => {
                const foundZone = zones.find(z => safeArr(z.assignedUsers).includes(user.id)); setCurrentZone(foundZone);
                const today = new Date().toDateString(); const myLogsToday = logs.filter(l => l.uid === user.id && new Date(l.timestamp).toDateString() === today); setTodayLog({ in: myLogsToday.find(l => l.type === 'IN'), out: myLogsToday.find(l => l.type === 'OUT') });
                if(foundZone) { navigator.geolocation.watchPosition(pos => { const d = calculateDistance(pos.coords.latitude, pos.coords.longitude, foundZone.lat, foundZone.lng); setMyStatus(d <= foundZone.radius ? 'inside' : 'outside'); }, err => setMyStatus('error')); } else { setMyStatus('no_zone'); }
            }, [zones, logs]);

            const handleAttendance = (type) => { if(myStatus !== 'inside' && !isAdmin) return alert('ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ'); push(ref(db, 'attendance'), { uid: user.id, type, timestamp: new Date().toISOString() }); alert(`ØªÙ… ØªØ³Ø¬ÙŠÙ„ ${type==='IN'?'Ø§Ù„Ø¯Ø®ÙˆÙ„':'Ø§Ù„Ø®Ø±ÙˆØ¬'} Ø¨Ù†Ø¬Ø§Ø­`); };
            const handleSaveZone = (z) => { if(z.id) { const { id, ...data } = z; update(ref(db, `zones/${id}`), data); } else { push(ref(db, 'zones'), z); } setModalOpen(false); setEditingZone(null); };
            const openAddModal = () => { setEditingZone(null); setModalOpen(true); }; const openEditModal = (zone) => { setEditingZone(zone); setModalOpen(true); };

            return (
                <div className="flex min-h-screen bg-slate-50">
                    <aside className="w-64 bg-white border-l h-screen sticky top-0 flex flex-col">
                        <div className="p-6 flex items-center gap-2 font-black text-xl text-brand-900 border-b"><Logo size={32} /> Ø¨ÙŠÙˆØªÙƒÙ…</div>
                        <nav className="flex-1 p-4 space-y-2">
                            <button onClick={()=>setPage('my_attendance')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold transition ${page==='my_attendance'?'bg-accent-600 text-white':'text-gray-500 hover:bg-gray-50'}`}><Icon name="fingerprint"/> ØªØ³Ø¬ÙŠÙ„ÙŠ</button>
                            {canSeeReports && (<><button onClick={()=>setPage('live')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold transition ${page==='live'?'bg-accent-600 text-white':'text-gray-500 hover:bg-gray-50'}`}><Icon name="activity"/> Ù…Ø¨Ø§Ø´Ø± (Live)</button><button onClick={()=>setPage('reports')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold transition ${page==='reports'?'bg-accent-600 text-white':'text-gray-500 hover:bg-gray-50'}`}><Icon name="file-text"/> Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø®ØµÙˆÙ…Ø§Øª</button></>)}
                            {canManageZones && <button onClick={()=>setPage('zones')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold transition ${page==='zones'?'bg-accent-600 text-white':'text-gray-500 hover:bg-gray-50'}`}><Icon name="map"/> Ø§Ù„Ù†Ø·Ø§Ù‚Ø§Øª</button>}
                        </nav>
                        <div className="p-4 border-t"><button onClick={onBack} className="w-full bg-gray-100 text-gray-600 p-2 rounded-lg font-bold flex items-center justify-center gap-2"><Icon name="grid" size={16}/> ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</button></div>
                    </aside>
                    <main className="flex-1 p-8 overflow-y-auto">
                        <header className="flex justify-between items-center mb-8"><h2 className="text-2xl font-bold text-brand-900">{page==='my_attendance'?'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±':page==='live'?'Ø§Ù„Ù…ØªÙˆØ§Ø¬Ø¯ÙˆÙ† Ø§Ù„Ø¢Ù†':page==='reports'?'Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±':'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ø·Ø§Ù‚Ø§Øª'}</h2><div className="flex items-center gap-2"><div className="text-sm font-bold">{user.name}</div><div className="w-8 h-8 bg-accent-600 rounded-full text-white flex items-center justify-center">{user.name[0]}</div></div></header>
                        {page === 'my_attendance' && (<div className="max-w-2xl mx-auto text-center space-y-6"><div className={`p-8 rounded-3xl shadow-lg border-4 ${myStatus==='inside'?'bg-green-50 border-green-500':myStatus==='outside'?'bg-red-50 border-red-500':'bg-gray-50 border-gray-300'}`}><div className="text-6xl mb-4">{myStatus==='inside'?'ğŸ“':myStatus==='outside'?'ğŸš«':'â“'}</div><h3 className="text-2xl font-black mb-2">{myStatus==='inside'?'Ø£Ù†Øª Ø¯Ø§Ø®Ù„ Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ù…Ù„':myStatus==='outside'?'Ø£Ù†Øª Ø®Ø§Ø±Ø¬ Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ù…Ù„':'Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹...'}</h3><p className="text-gray-500">{currentZone ? `Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ù…ØµØ±Ø­: ${currentZone.name}` : 'Ù„Ù… ÙŠØªÙ… Ø±Ø¨Ø·Ùƒ Ø¨Ù†Ø·Ø§Ù‚ Ø¹Ù…Ù„ØŒ Ø±Ø§Ø¬Ø¹ Ø§Ù„Ù…Ø´Ø±Ù'}</p></div><div className="grid grid-cols-2 gap-4"><button onClick={()=>handleAttendance('IN')} disabled={myStatus!=='inside' || todayLog.in} className="bg-green-600 text-white py-6 rounded-2xl font-black text-xl shadow-xl hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed flex flex-col items-center gap-2"><Icon name="log-in" size={32}/> ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ <span className="text-sm font-normal opacity-80">{todayLog.in ? formatTime(todayLog.in.timestamp) : '--:--'}</span></button><button onClick={()=>handleAttendance('OUT')} disabled={!todayLog.in} className="bg-red-600 text-white py-6 rounded-2xl font-black text-xl shadow-xl hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed flex flex-col items-center gap-2"><Icon name="log-out" size={32}/> Ø§Ù†ØµØ±Ø§Ù <span className="text-sm font-normal opacity-80">{todayLog.out ? formatTime(todayLog.out.timestamp) : '--:--'}</span></button></div>{todayLog.in && (<div className="bg-white p-4 rounded-xl shadow-sm border flex justify-between items-center"><span className="font-bold text-gray-600">Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„ÙŠÙˆÙ…:</span><span className="font-black text-2xl text-accent-600 date-en">{todayLog.out ? calculateDuration(todayLog.in.timestamp, todayLog.out.timestamp) : 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨...'}</span></div>)}</div>)}
                        {page === 'zones' && (<div><button onClick={openAddModal} className="bg-accent-600 text-white px-6 py-3 rounded-xl font-bold mb-6 shadow-lg">+ Ø¥Ø¶Ø§ÙØ© Ù†Ø·Ø§Ù‚ Ø¬Ø¯ÙŠØ¯</button><div className="grid gap-4">{zones.map(z => (<div key={z.id} className="bg-white p-5 rounded-2xl shadow-sm border flex justify-between items-center"><div><h4 className="font-bold text-lg text-brand-900">{z.name}</h4><div className="text-sm text-gray-500 date-en">{z.startTime} - {z.endTime}</div></div><div className="flex items-center gap-3"><span className="bg-gray-100 text-gray-600 px-3 py-1 rounded-full text-sm font-bold">{safeArr(z.assignedUsers).length} Ù…ÙˆØ¸Ù</span><button onClick={()=>openEditModal(z)} className="bg-gray-100 p-2 rounded-lg hover:bg-gray-200 text-brand-900"><Icon name="pencil" size={16}/></button></div></div>))}</div></div>)}
                        {page === 'reports' && <AttendanceReports logs={logs} users={usersList} zones={zones} />}
                        {page === 'live' && (<div className="grid grid-cols-1 md:grid-cols-3 gap-4">{usersList.filter(u => u.id !== 'admin').map(u => { const lastLog = logs.filter(l => l.uid === u.id).sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp))[0]; const isOnline = lastLog?.type === 'IN' && new Date(lastLog.timestamp).toDateString() === new Date().toDateString(); return ( <div key={u.id} className="bg-white p-5 rounded-2xl shadow-sm border flex items-center gap-4"><div className={`w-4 h-4 rounded-full ${isOnline?'bg-green-500 animate-pulse':'bg-gray-300'}`}></div><div><div className="font-bold text-brand-900">{u.name}</div><div className="text-xs text-gray-500">{isOnline ? `Ø¯Ø®Ù„ Ù…Ù†Ø° ${formatTime(lastLog.timestamp)}` : 'ØºÙŠØ± Ù…ØªÙˆØ§Ø¬Ø¯'}</div></div></div> ) })}</div>)}
                    </main>
                    <ZoneModal isOpen={modalOpen} onClose={()=>setModalOpen(false)} users={usersList} zones={zones} onSave={handleSaveZone} zoneToEdit={editingZone} />
                </div>
            );
        };

        // --- 7. MAIN ORCHESTRATOR (UNCHANGED) ---
        const App = () => {
            const [user, setUser] = useState(null); const [dbUser, setDbUser] = useState(null); const [currentApp, setCurrentApp] = useState('portal'); const [clients, setClients] = useState([]); const [users, setUsers] = useState([]); const [zones, setZones] = useState([]); const [logs, setLogs] = useState([]); const [loading, setLoading] = useState(true);
            useEffect(() => { const unsub = onAuthStateChanged(auth, u => { if (u) { setUser(u); onValue(ref(db, 'users'), s => { const data = s.val() || {}; const list = Object.keys(data).map(k => ({ id: k, ...data[k] })); setUsers(list); const profile = list.find(x => x.email.toLowerCase() === u.email.toLowerCase()); if (u.email.toLowerCase() === 'asleh@boyoticom.com') { setDbUser({ ...profile, id: u.uid, role: 'admin', name: 'Ali Saleh', email: u.email }); } else { setDbUser(profile ? { ...profile, id: u.uid } : { id: u.uid, email: u.email, role: 'employee', name: 'Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯' }); } }); onValue(ref(db, 'clients'), s => setClients(s.val() ? Object.keys(s.val()).map(k => ({id:k, ...s.val()[k]})).reverse() : [])); onValue(ref(db, 'zones'), s => setZones(s.val() ? Object.keys(s.val()).map(k => ({id:k, ...s.val()[k]})) : [])); onValue(ref(db, 'attendance'), s => setLogs(s.val() ? Object.keys(s.val()).map(k => ({id:k, ...s.val()[k]})) : [])); } else { setUser(null); setDbUser(null); } setLoading(false); }); return () => unsub(); }, []);
            const handleSaveClient = (data, existing, log) => { 
                const payload = { ...data, assignedTo: safeStr(data.assignedTo), projects: safeArr(data.projects) }; 
                if (existing) {
                    update(ref(db, `clients/${existing.id}`), payload);
                    if(log) push(ref(db, `clients/${existing.id}/history`), log);
                } else { 
                    push(ref(db, 'clients'), { ...payload, dateAdded: new Date().toISOString(), addedBy: dbUser.email }); 
                } 
            };
            const handleImport = (data) => { if(!confirm(`Ø³ÙŠØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${data.length} Ø¹Ù…ÙŠÙ„. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ`)) return; data.forEach(row => { push(ref(db, 'clients'), { name: row['Ø§Ù„Ø§Ø³Ù…']||row['Name']||'No Name', phone: row['Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ']||row['Phone']||'', projects: [row['Ø§Ù„Ù…Ø´Ø±ÙˆØ¹']||''], status: 'New', addedBy: dbUser.email, dateAdded: new Date().toISOString() }); }); alert('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­!'); };
            if (loading) return <div className="h-screen flex items-center justify-center"><div className="loader"></div></div>;
            if (!user) return <Login />;
            if (!dbUser) return <div className="h-screen flex items-center justify-center"><div className="loader"></div></div>;
            if (currentApp === 'crm') return <CRMApp user={dbUser} clients={clients} users={users} onSaveClient={handleSaveClient} onImport={handleImport} onBack={() => setCurrentApp('portal')} />;
            if (currentApp === 'attendance') return <AttendanceApp user={dbUser} zones={zones} usersList={users} logs={logs} onBack={() => setCurrentApp('portal')} />;
            return <Portal user={dbUser} users={users} onSelectApp={setCurrentApp} />;
        };

        const root = window.ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
